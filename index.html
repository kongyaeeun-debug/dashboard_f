<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRI Executive Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
    </style>
</head>

<body class="text-gray-800">

    <!-- Top Nav -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-indigo-600 tracking-tight">LRI Dashboard</span>
                    <span class="ml-4 px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-semibold rounded-full">Pro
                        Ver.</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">Data: 2026.01.31 (Sat)</div>
                    <button
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition"
                        onclick="generateMockData()">ğŸ”„ Refresh Data</button>
                    <!-- Alert Badge -->
                    <div id="alert-badge"
                        class="hidden flex items-center bg-red-100 text-red-700 px-3 py-1 rounded-md text-sm font-bold animate-pulse">
                        ğŸš¨ RED ALERT: <span id="alert-count" class="ml-1">0</span>ê±´
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

        <!-- 1. KPI Section -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Total Score -->
            <div class="card border-l-4 border-indigo-500">
                <h3 class="text-sm font-medium text-gray-500">ì˜¤ëŠ˜ì˜ ë³‘ì› ì¢…í•© LRI</h3>
                <div class="mt-2 flex items-baseline">
                    <p class="text-3xl font-bold text-gray-900" id="total-lri">0</p>
                    <p class="ml-2 flex items-baseline text-sm font-semibold text-green-600">
                        <span id="lri-diff">â–² 2.4%</span>
                    </p>
                </div>
                <p class="mt-1 text-xs text-gray-400">ì „ì¼ ëŒ€ë¹„ ìƒìŠ¹</p>
            </div>

            <!-- Golden Peak -->
            <div class="card border-l-4 border-amber-400">
                <h3 class="text-sm font-medium text-gray-500">Golden Peak (ì¶©ì„±)</h3>
                <div class="mt-2 flex items-baseline">
                    <p class="text-3xl font-bold text-gray-900" id="count-golden">0</p>
                    <span class="ml-2 text-sm text-gray-500">ëª…</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                    <div class="bg-amber-400 h-1.5 rounded-full" id="bar-golden" style="width: 0%"></div>
                </div>
            </div>

            <!-- Red Alert -->
            <div class="card border-l-4 border-red-500">
                <h3 class="text-sm font-medium text-gray-500">Red Alert (ì´íƒˆìœ„í—˜)</h3>
                <div class="mt-2 flex items-baseline">
                    <p class="text-3xl font-bold text-red-600" id="count-red">0</p>
                    <span class="ml-2 text-sm text-gray-500">ëª…</span>
                </div>
                <p class="mt-1 text-xs text-red-500 font-bold" id="red-msg">ì¡°ì¹˜ í•„ìš”</p>
            </div>

            <!-- Net Promoter Est -->
            <div class="card border-l-4 border-green-500">
                <h3 class="text-sm font-medium text-gray-500">ì˜ˆìƒ ì¬ë°©ë¬¸ìœ¨</h3>
                <div class="mt-2 flex items-baseline">
                    <p class="text-3xl font-bold text-gray-900" id="retention-rate">0%</p>
                </div>
                <p class="mt-1 text-xs text-gray-400">AI ì˜ˆì¸¡ ëª¨ë¸ ê¸°ë°˜</p>
            </div>
        </div>

        <!-- 2. Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Daily Status Donut -->
            <div class="card">
                <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“Š ì˜¤ëŠ˜ì˜ ê³ ê° ë“±ê¸‰ í˜„í™©</h3>
                <div class="relative h-64 w-full flex justify-center">
                    <canvas id="donutChart"></canvas>
                </div>
            </div>

            <!-- Funnel Waterfall -->
            <div class="card">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex justify-between">
                    ğŸ“‰ ìƒë‹´ ì—¬ì •ë³„ í¼ë„ (Drop-off Check)
                    <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 font-normal self-center">5ì  ë§Œì 
                        ê¸°ì¤€</span>
                </h3>
                <div class="relative h-64 w-full">
                    <canvas id="funnelChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 3. Action Table (Red Alert) -->
        <div class="card bg-white overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-900 flex items-center">
                    ğŸš¨ ê¸´ê¸‰ ê´€ë¦¬ ë¦¬ìŠ¤íŠ¸ (Red Alert)
                    <span class="ml-2 text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full" id="table-badge">Update
                        Live</span>
                </h3>
                <div class="text-sm text-gray-500">â€» Q6/Q7 2ì  ì´í•˜ ê³¼ë½ í¬í•¨</div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ê³ ê°ëª…</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                LRI ì ìˆ˜</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ë‹´ë‹¹ì</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ì·¨ì•½ í¬ì¸íŠ¸ (ìµœì €ì )</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ìƒíƒœ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ì¡°ì¹˜</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="alert-table-body">
                        <!-- Rows rendered via JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // --- 1. Data Logic & Mock Generator ---

        let donutChartInstance = null;
        let funnelChartInstance = null;

        const doctors = ["ê¹€ì›ì¥", "ì´ì›ì¥", "ë°•ì›ì¥"];
        const staff = ["ìµœì‹¤ì¥", "ì •ì‹¤ì¥", "ê°•ì‹¤ì¥"];
        const names = ["ê¹€*ì§€", "ì´*ì˜", "ë°•*ìˆ˜", "ìµœ*ì€", "ì •*ìš°", "ê°•*ë¯¼", "ì¡°*ì•„", "ìœ¤*ì„œ", "ì¥*í˜", "ì„*ì†”"];

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateCustomer() {
            // Randomly generate 10 guideline scores
            // Bias towards 3~5 for realism, but inject some low scores for simulation
            const scores = {};
            for (let i = 1; i <= 10; i++) {
                // 10% chance of extreme low score (1~2)
                if (Math.random() < 0.15) scores[`q${i}`] = getRandomInt(1, 2);
                else scores[`q${i}`] = getRandomInt(3, 5);
            }

            // Calculate Averages
            const s_t0 = (scores.q1 + scores.q2) / 2;
            const s_pattern = (scores.q3 + scores.q4 + scores.q5) / 3;
            const s_fric = (scores.q6 + scores.q7 + scores.q8) / 3;
            const s_res = (scores.q9 + scores.q10) / 2;

            // LRI Formula: (T0*0.4 + Fric*0.3 + Patt*0.2 + Res*0.1) * 20
            const lri = ((s_t0 * 0.4) + (s_fric * 0.3) + (s_pattern * 0.2) + (s_res * 0.1)) * 20;

            // Segmentation
            let grade = "";
            let isRedAlert = false;
            let failReason = "";

            // Check Deal Breakers (Q6, Q7 <= 2)
            if (scores.q6 <= 2) { isRedAlert = true; failReason = "ì˜ì‚¬ ì‹ ë¢°(Q6) ê³¼ë½"; }
            else if (scores.q7 <= 2) { isRedAlert = true; failReason = "ë¹„ìš© ê°•ìš”(Q7) ê³¼ë½"; }

            if (isRedAlert || lri < 60) {
                grade = "Red Alert";
            } else if (lri >= 90) {
                grade = "Golden Peak";
            } else if (lri >= 75) {
                grade = "Safe Zone";
            } else {
                grade = "Friction Danger";
            }

            // Find lowest point for Red Alert table
            let lowestQ = "q1";
            let minVal = 6;
            for (let k in scores) {
                if (scores[k] < minVal) { minVal = scores[k]; lowestQ = k; }
            }
            const qNames = {
                q1: "ì›ì¸íŒŒì•…", q2: "í•´ê²°í™•ì‹ ",
                q3: "ì†”ì§í•¨", q4: "ì‹œê°í™”", q5: "ê³µê°",
                q6: "ì˜ì‚¬ì‹ ë¢°", q7: "ë¹„ìš©íˆ¬ëª…", q8: "ì‹œìŠ¤í…œ",
                q9: "ì¶”ì²œ", q10: "ì •ì°©"
            };

            return {
                name: names[getRandomInt(0, names.length - 1)],
                doctor: doctors[getRandomInt(0, doctors.length - 1)],
                staff: staff[getRandomInt(0, staff.length - 1)],
                lri: Math.round(lri),
                grade: grade,
                isRedAlert: isRedAlert,
                failReason: failReason,
                lowestPoint: `${qNames[lowestQ]} (${minVal}ì )`,
                scores: scores,
                stepScores: {
                    system: scores.q8,
                    buildup: (scores.q4 + scores.q5) / 2,
                    core: (scores.q1 + scores.q2 + scores.q6) / 3,
                    hurdle: (scores.q3 + scores.q7) / 2,
                    final: (scores.q9 + scores.q10) / 2
                }
            };
        }

        function generateMockData() {
            const data = [];
            // Generate 30 customers
            for (let i = 0; i < 30; i++) data.push(generateCustomer());

            updateDashboard(data);
        }

        function updateDashboard(data) {
            // 0. Pre-calculate Lists for Consistency
            const redList = data.filter(d => d.grade === "Red Alert").sort((a, b) => a.lri - b.lri);
            const redCount = redList.length;
            const goldenCount = data.filter(d => d.grade === "Golden Peak").length;
            const totalLri = data.reduce((acc, cur) => acc + cur.lri, 0) / data.length;
            const retentionRate = (goldenCount + data.filter(d => d.grade === "Safe Zone").length) / data.length * 100;

            // 1. KPI Cards
            document.getElementById('total-lri').innerText = totalLri.toFixed(1);
            document.getElementById('count-golden').innerText = goldenCount;
            document.getElementById('bar-golden').style.width = `${(goldenCount / data.length) * 100}%`;
            document.getElementById('count-red').innerText = redCount; // Synced with List
            document.getElementById('retention-rate').innerText = `${retentionRate.toFixed(1)}%`;

            // 2. Alert Badge (Nav)
            const alertBadge = document.getElementById('alert-badge');
            if (redCount > 0) {
                alertBadge.classList.remove('hidden');
                document.getElementById('alert-count').innerText = redCount;
            } else {
                alertBadge.classList.add('hidden');
            }

            // 3. Action Table (Synced)
            const tbody = document.getElementById('alert-table-body');
            tbody.innerHTML = "";
            document.getElementById('table-badge').innerText = `Live (${redCount}ëª…)`;

            redList.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">${d.lri}ì </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d.doctor} / ${d.staff}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            ${d.failReason || d.lowestPoint}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="text-red-500 font-bold">â— ì´íƒˆ ìœ„í—˜</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-1 rounded text-xs transition">ğŸ“ í•´í”¼ì½œ</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (redCount === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-400">ğŸš¨ í˜„ì¬ ê¸´ê¸‰ ê´€ë¦¬ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            }

            // 4. Charts Update
            const grades = { "Golden Peak": 0, "Safe Zone": 0, "Friction Danger": 0, "Red Alert": 0 };
            data.forEach(d => grades[d.grade]++);
            renderDonut(grades);

            // Funnel Logic (Preserve Sequential)
            const s1 = data;
            const s2 = s1.filter(d => (d.scores.q4 + d.scores.q5) / 2 >= 4.0);
            const s3 = s2.filter(d => (d.scores.q1 + d.scores.q2 + d.scores.q6) / 3 >= 4.0);
            const s4 = s3.filter(d => (d.scores.q3 + d.scores.q7) / 2 >= 4.0);
            const s5 = s4.filter(d => (d.scores.q9 + d.scores.q10) / 2 >= 4.0);
            renderFunnel([s1.length, s2.length, s3.length, s4.length, s5.length]);
        }

        function renderDonut(grades) {
            const ctx = document.getElementById('donutChart').getContext('2d');
            if (donutChartInstance) donutChartInstance.destroy();

            donutChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(grades),
                    datasets: [{
                        data: Object.values(grades),
                        backgroundColor: ['#fbbf24', '#34d399', '#f87171', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function renderFunnel(counts) {
            const ctx = document.getElementById('funnelChart').getContext('2d');
            if (funnelChartInstance) funnelChartInstance.destroy();

            // Counts: [30, 25, 20, 18, 10] etc.
            const maxVal = counts[0];
            const center = maxVal / 2;

            // Transform for Centered Funnel
            const floatingData = counts.map(count => {
                const half = count / 2;
                return [center - half, center + half];
            });

            // Color Logic: Red if Drop-off > 30%
            const bgColors = counts.map((count, idx) => {
                if (idx === 0) return '#6366f1'; // Base

                const prev = counts[idx - 1];
                if (prev === 0) return '#ef4444';

                const dropOffRate = (prev - count) / prev;
                // 30% threshold
                if (dropOffRate > 0.3) return '#ef4444'; // Red (Danger)
                return '#10b981'; // Green (Safe)
            });

            funnelChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1.ì²«ì¸ìƒ(All)', '2.ê³µê°(Q4,5)', '3.í™•ì‹ (Q1,2,6)', '4.ì¥ë²½(Q3,7)', '5.ì¬ë°©ë¬¸(Q9,10)'],
                    datasets: [{
                        label: 'ìƒì¡´ ì¸ì›',
                        data: floatingData,
                        backgroundColor: bgColors,
                        borderRadius: 4,
                        barPercentage: 0.8
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 0, max: maxVal,
                            grid: { display: false },
                            ticks: { display: false }
                        },
                        y: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const idx = context.dataIndex;
                                    const count = counts[idx];

                                    if (idx === 0) return `ì¸ì›: ${count}ëª… (ì‹œì‘)`;

                                    const prev = counts[idx - 1];
                                    const dropOff = ((prev - count) / prev * 100).toFixed(1);
                                    return `ì¸ì›: ${count}ëª… (ì´íƒˆë¥ : ${dropOff}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Init
        generateMockData();

    </script>
</body>


</html>
